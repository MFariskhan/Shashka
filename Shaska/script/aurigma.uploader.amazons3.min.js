(function(n){function r(n,t,i){if(i)this["_"+n]=t;else return this["_"+n]}var i=(n.Aurigma||(n.Aurigma={__namespace:!0}))&&(n.Aurigma.ImageUploader||(n.Aurigma.ImageUploader={__namespace:!0}));i.amazonS3Extender=function(n){if(!(this instanceof i.amazonS3Extender))return new i.amazonS3Extender(n);n.state()==1&&$au.debug().showError("AmazonS3Extender should be created before uploader initialization."),this._uploader=n,this._converters=new i.amazonS3Extender.converters,this._converterIndex=-1;var t=this;n.events().beforeSendRequest().add(function(){return t._onBeforeSendRequest.apply(t,arguments)}),n.events().initComplete().add(function(){return t._onInitComplete.apply(t,arguments)}),n.events().beforeUpload().add(function(){return t._onBeforeUpload.apply(t,arguments)})},i.amazonS3Extender.prototype={__class:!0,predefinedFields:{description:"Description_[itemIndex]",width:"Width_[itemIndex]",height:"Height_[itemIndex]",angle:"Angle_[itemIndex]",sourceName:"SourceName_[itemIndex]",horizontalResolution:"HorizontalResolution_[itemIndex]",verticalResolution:"VerticalResolution_[itemIndex]",sourceFileSize:"SourceSize_[itemIndex]",sourceCreatedDateTime:"SourceCreatedDateTime_[itemIndex]",sourceLastModifiedDateTime:"SourceLastModifiedDateTime_[itemIndex]",sourceCreatedDateTimeLocal:"SourceCreatedDateTimeLocal_[itemIndex]",sourceLastModifiedDateTimeLocal:"SourceLastModifiedDateTimeLocal_[itemIndex]",thumbnailSucceeded:"Thumbnail[converterIndex]Succeeded_[itemIndex]",fileMode:"File[converterIndex]Mode_[itemIndex]",fileSize:"File[converterIndex]Size_[itemIndex]",fileWidth:"File[converterIndex]Width_[itemIndex]",fileHeight:"File[converterIndex]Height_[itemIndex]",fileName:"File[converterIndex]Name_[itemIndex]",packageFileCount:"PackageFileCount",packageIndex:"PackageIndex",packageCount:"PackageCount",packageGuid:"PackageGuid",cropBounds:"CropBounds_[itemIndex]"},_prop:r,bucket:function(n){return this._prop("bucket",n,arguments.length)},accessKeyId:function(n){return this._prop("accessKeyId",n,arguments.length)},region:function(n){return this._prop("region",n,arguments.length)},bucketHostName:function(n){return this._prop("bucketHostName",n,arguments.length)},checkIntegrity:function(n){return this._prop("checkIntegrity",n,arguments.length)},converters:function(n){if(arguments.length==0)return this._converters;this._converters.set(n)},_onBeforeSendRequest:function(){var p=this._uploader,c=++this._converterIndex%this._converterCount,n=p.metadata(),v="x-amz-meta-",a,f,t,y,o,r,i,s,u,e,l,h;n.enableAllStandardFields(!1),a=this._getNowString(),n.addCustomField("x-amz-credential",this.accessKeyId()+"/"+a+"/"+this.region()+"/s3/aws4_request"),n.addCustomField("x-amz-algorithm","AWS4-HMAC-SHA256"),n.addCustomField("x-amz-date",a+"T000000Z"),n.addCustomField("success_action_status","200"),n.enableStandardField("File[converterIndex]_[itemIndex]",!0),n.renameStandardField("File[converterIndex]_[itemIndex]","file"),this.checkIntegrity()&&(n.enableStandardField("File[converterIndex]MD5_[itemIndex]",!0),n.renameStandardField("File[converterIndex]MD5_[itemIndex]","Content-MD5")),f=this.converters().get((c+this._converterCount-1)%this._converterCount).meta();if(f&&f.length>0)for(i=0,s=f.length;i<s;i++)u=f[i],u.name&&u.value!=null&&n.removeCustomField(v+u.name);t=this.converters().get(c);if(t){y=t.key()?t.key():"",n.addCustomField("acl",t.acl()),n.addCustomField("key",y),n.addCustomField("policy",t.policy()),n.addCustomField("x-amz-signature",t.signature()),o=t.contentType(),o!=null&&o!=""&&n.addCustomField("Content-Type",o),t.cacheControl()&&n.addCustomField("Cache-Control",t.cacheControl()),t.expires()&&n.addCustomField("Expires",t.expires()),t.storageClass()&&n.addCustomField("x-amz-storage-class",t.storageClass()),r=t.meta();if(r&&r.length>0)for(i=0,s=r.length;i<s;i++)u=r[i],e=u.name,e&&(l=r[i].value,h=r[i].field,h!=null?(n.renameStandardField(h,v+e),n.enableStandardField(h,!0)):l!=null&&n.addCustomField(v+e,l))}this._converterIndex=c},_getNowString:function(){var t=new Date,r=t.getFullYear().toString(),i=(t.getMonth()+1).toString(),n;return r+=i.length==1?"0"+i:i,n=t.getDate().toString(),r+=n.length==1?"0"+n:n},_onInitComplete:function(){var i=this._uploader,r=this.bucketHostName()?this.bucketHostName():this.bucket()+".s3.amazonaws.com",t=i.uploadSettings();t.actionUrl(n.location.protocol+"//"+r+"/"),t.uploadConverterOutputSeparately(!0),t.filesPerPackage(1),i.type()=="java"&&t.enableHeadRequest(!1),t.chunkSize(0),this.region()||$au.debug().showError("Now you must specify the region field along with other AmazonS3Extender settings.")},_onBeforeUpload:function(){var t,r,n,i;for(this._converterCount=this._uploader.converters().count(),this._converterIndex=-1,t=this._uploader.converters(),r=this.checkIntegrity()?"MD5":"",n=0,i=t.count();n<i;n++)t.get(n).hash(r)}},i.amazonS3Extender.prototype.constructor=i.amazonS3Extender,i.amazonS3Extender.converters=function(){if(!(this instanceof i.amazonS3Extender.converters))return new i.amazonS3Extender.converters;this._list={}},i.amazonS3Extender.converters.prototype={__class:!0,clear:function(){this._list={}},count:function(){var n=0,t;if(this._list)for(t in this._list)n++;return n},get:function(n){return this._list[n]||(this._list[n]=new i.amazonS3Extender.fileSettings),this._list[n]},remove:function(n){this._list.splice(n,1)},set:function(n){for(var f,r,t,u=0,e=n.length;u<e;u++){f=new i.amazonS3Extender.fileSettings,r=n[u],this._list[u]=f;for(t in r)(!r.hasOwnProperty||r.hasOwnProperty(t))&&(typeof f[t]=="function"?f[t](r[t]):showWarning('$au.amazonS3Extender.fileSettings has not "'+t+'" property.'))}}},i.amazonS3Extender.converters.prototype.constructor=i.amazonS3Extender.converters,i.amazonS3Extender.fileSettings=function(){if(!(this instanceof i.amazonS3Extender.fileSettings))return new i.amazonS3Extender.fileSettings;this._meta=[]},i.amazonS3Extender.fileSettings.prototype={__class:!0,_prop:r,acl:function(n){return this._prop("acl",n,arguments.length)},key:function(n){return this._prop("key",n,arguments.length)},policy:function(n){return this._prop("policy",n,arguments.length)},signature:function(n){return this._prop("signature",n,arguments.length)},contentType:function(n){return this._prop("contentType",n,arguments.length)},storageClass:function(n){return this._prop("storageClass",n,arguments.length)},cacheControl:function(n){return this._prop("cacheControl",n,arguments.length)},expires:function(n){return this._prop("expires",n,arguments.length)},meta:function(n){return this._prop("meta",n,arguments.length)}},i.amazonS3Extender.fileSettings.prototype.constructor=i.amazonS3Extender.fileSettings,n.$au||typeof $au=="undefined"||(n.$au=$au),n.$au&&(n.$au.uploader=$au.uploader)})(window)